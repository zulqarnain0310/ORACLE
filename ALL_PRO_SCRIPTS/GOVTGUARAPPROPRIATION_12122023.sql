--------------------------------------------------------
--  DDL for Procedure GOVTGUARAPPROPRIATION_12122023
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" /*=====================================
AUTHER : TRILOKI KHANNA
CREATE DATE : 27-11-2019
MODIFY DATE : 27-11-2019
DESCRIPTION :Govt Guar Appropriation
EXEC pro.GovtGuarAppropriation   @TIMEKEY=25140
====================================*/
(
  v_TimeKey IN NUMBER
)
AS

BEGIN

   BEGIN

      BEGIN
         /*-----UPDATE AppGovGur =0 --------------------------*/
         MERGE INTO A 
         USING (SELECT A.ROWID row_id, 0
         FROM A ,PRO_RBL_MISDB_PROD.ACCOUNTCAL A
                JOIN PRO_RBL_MISDB_PROD.CUSTOMERCAL B   ON A.CustomerEntityID = B.CustomerEntityID 
          WHERE B.FlgProcessing = 'N') src
         ON ( A.ROWID = src.row_id )
         WHEN MATCHED THEN UPDATE SET A.AppGovGur = 0;
         IF utils.object_id('TEMPDB..tt_TEMPTABLEAppGovGur_3') IS NOT NULL THEN
          EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_TEMPTABLEAppGovGur_3 ';
         END IF;
         DELETE FROM tt_TEMPTABLEAppGovGur_3;
         UTILS.IDENTITY_RESET('tt_TEMPTABLEAppGovGur_3');

         INSERT INTO tt_TEMPTABLEAppGovGur_3 ( 
         	SELECT A.AccountEntityID ,
                 (CASE 
                       WHEN SUM(A.NetBalance) OVER ( PARTITION BY A.CustomerEntityID ) > 0 THEN (A.GovtGtyAmt * (A.NetBalance / SUM(A.NetBalance) OVER ( PARTITION BY A.CustomerEntityID )))   END) GovGur  
         	  FROM PRO_RBL_MISDB_PROD.ACCOUNTCAL A
         	 WHERE  A.FacilityType IN ( 'BP','BD' )

                    AND NVL(A.GovtGtyAmt, 0) > 0 );
         MERGE INTO A 
         USING (SELECT A.ROWID row_id, B.GovGur
         FROM A ,PRO_RBL_MISDB_PROD.ACCOUNTCAL A
                JOIN tt_TEMPTABLEAppGovGur_3 B   ON A.AccountEntityID = B.AccountEntityID 
          WHERE A.FacilityType IN ( 'BP','BD' )
         ) src
         ON ( A.ROWID = src.row_id )
         WHEN MATCHED THEN UPDATE SET A.AppGovGur = src.GovGur;
         MERGE INTO A 
         USING (SELECT A.ROWID row_id, GovtGtyAmt
         FROM A ,PRO_RBL_MISDB_PROD.ACCOUNTCAL A 
          WHERE NOT ( A.FacilityType IN ( 'BP','BD' )
          )) src
         ON ( A.ROWID = src.row_id )
         WHEN MATCHED THEN UPDATE SET A.AppGovGur = GovtGtyAmt;
         UPDATE PRO_RBL_MISDB_PROD.AclRunningProcessStatus
            SET COMPLETED = 'Y',
                ERRORDATE = NULL,
                ERRORDESCRIPTION = NULL,
                COUNT = NVL(COUNT, 0) + 1
          WHERE  RUNNINGPROCESSNAME = 'GovtGuarAppropriation';
         EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_TEMPTABLEAppGovGur_3 ';

      END;
   EXCEPTION
      WHEN OTHERS THEN

   BEGIN
      -----------------Added for DashBoard 04-03-2021
      --Update BANDAUDITSTATUS set CompletedCount=CompletedCount+1 where BandName='ASSET CLASSIFICATION'
      UPDATE PRO_RBL_MISDB_PROD.AclRunningProcessStatus
         SET COMPLETED = 'N',
             ERRORDATE = SYSDATE,
             ERRORDESCRIPTION = SQLERRM,
             COUNT = NVL(COUNT, 0) + 1
       WHERE  RUNNINGPROCESSNAME = 'GovtGuarAppropriation';

   END;END;

EXCEPTION WHEN OTHERS THEN utils.handleerror(SQLCODE,SQLERRM);
END;

/

  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "PREMOC_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "QPI_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ALERT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "DWH_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "CURDAT_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "BS_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ACL_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ROLE_LOCAL_RBL_MISDB_PROD_ORACLE";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "PREMOC_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "QPI_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ALERT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "DWH_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "D2KMNTR_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "CURDAT_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "BS_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ACL_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ETL_MAIN_RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_MISDB_PROD";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "DATAUPLOAD_RBL_MISDB_PROD";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ROLE_ALL_DB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "CC_CDR_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_BI_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "BSG_READ_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "STD_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_TEMPDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "STG_FIN_RBL_STGDB";
  GRANT EXECUTE ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ADF_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ROLE_ALL_DB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "CC_CDR_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_BI_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "BSG_READ_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "STD_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ETL_TEMP_RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "RBL_TEMPDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "STG_FIN_RBL_STGDB";
  GRANT DEBUG ON "MAIN_PRO"."GOVTGUARAPPROPRIATION_12122023" TO "ADF_CDR_RBL_STGDB";
